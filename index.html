<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Idle Tower Defense - Castelo Central com 4 Caminhos</title>
<style>
  body {
    font-family: sans-serif;
    background: #222;
    color: white;
    text-align: center;
  }
  #game {
    margin: 20px auto;
    width: 600px;
    height: 300px;
    background: #333;
    position: relative;
    overflow: hidden;
    border-radius: 10px;
    border: 2px solid #666;
  }
  .tower {
    width: 20px;
    height: 20px;
    background: lime;
    position: absolute;
    border-radius: 50%;
    transform: translate(-50%, -50%);
    z-index: 2;
  }
  .enemy {
    width: 20px;
    height: 20px;
    background: red;
    position: absolute;
    border-radius: 50%;
    transform: translate(-50%, -50%);
  }
  .hpbar {
    height: 4px;
    background: green;
    position: absolute;
    top: -6px;
    left: 0;
    border-radius: 2px;
  }
  .projectile {
    width: 6px;
    height: 6px;
    background: yellow;
    border-radius: 50%;
    position: absolute;
    transform: translate(-50%, -50%);
  }
  #castle {
    width: 60px;
    height: 60px;
    background: darkred;
    border: 3px solid #800000;
    border-radius: 10px;
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    z-index: 3;
  }
  #castleHpBar {
    position: absolute;
    top: 5px;
    left: 50%;
    transform: translateX(-50%);
    width: 80px;
    height: 10px;
    background: #444;
    border-radius: 5px;
    overflow: hidden;
    z-index: 4;
  }
  #castleHpBar > div {
    height: 100%;
    background: lime;
    width: 100%;
    transition: width 0.3s;
  }
  
</style>
</head>
<body>
  <h1>Idle Tower Defense - Castelo Central com 4 Caminhos</h1>
  <div>Ouro: <span id="gold">0</span></div>
  <div>Onda: <span id="wave">0</span></div>
  <div>Dano da Torre: <span id="damage">10</span></div>
  <div>Vida do Castelo: <span id="castleHpText">100</span></div>
  <button onclick="upgradeTower()">Upgrade Torre (50 ouro)</button>

  <div id="game">
    <div id="castle">
      <div id="castleHpBar"><div></div></div>
    </div>
  </div>

  <script>
    const gameArea = document.getElementById("game");
    const goldDisplay = document.getElementById("gold");
    const waveDisplay = document.getElementById("wave");
    const damageDisplay = document.getElementById("damage");
    const castleHpText = document.getElementById("castleHpText");
    const castleHpBarInner = document.querySelector("#castleHpBar > div");

    // Estado inicial
    let gold = parseInt(localStorage.getItem("gold")) || 0;
    let wave = parseInt(localStorage.getItem("wave")) || 0;
    let towerDamage = parseInt(localStorage.getItem("towerDamage")) || 10;

    goldDisplay.textContent = gold;
    waveDisplay.textContent = wave;
    damageDisplay.textContent = towerDamage;

    // Castelo
    let castleMaxHp = 100 + Math.floor(wave / 10) * 20;
    let castleHp = castleMaxHp;

    function updateCastleHp() {
      castleHpText.textContent = castleHp;
      const perc = Math.max(0, (castleHp / castleMaxHp) * 100);
      castleHpBarInner.style.width = perc + "%";
      if (castleHp <= 0) {
        alert("Game Over! O castelo foi destruído!");
        location.reload();
      }
    }
    updateCastleHp();

    // Definindo 4 caminhos diferentes com waypoints até o castelo (no centro 300,150)
    const centerX = 300;
    const centerY = 150;

  const paths = {
    norte: [
      { x: 300, y: -20 },
      { x: 300, y: 75 },
      { x: centerX, y: centerY }
    ],
    sul: [
      { x: 300, y: 320 },
      { x: 300, y: 225 },
      { x: centerX, y: centerY }
    ],
    leste: [
      { x: 620, y: 150 },
      { x: 450, y: 150 },
      { x: centerX, y: centerY }
    ],
    oeste: [
      { x: -20, y: 150 },
      { x: 150, y: 150 },
      { x: centerX, y: centerY }
    ]
  };

    // Spawn torres perto do castelo protegendo cada caminho
    const towers = [
      { x: 300, y: 70, range: 120, path: "norte" },  // movida mais para cima
      { x: 300, y: 230, range: 120, path: "sul" },   // movida mais para baixo
      { x: 470, y: 150, range: 120, path: "leste" },  // torre leste
      { x: 130, y: 150, range: 120, path: "oeste" }   // torre oeste
    ];

    // Criar elemento torre visual
    function spawnTower(tower) {
      const el = document.createElement("div");
      el.className = "tower";
      el.style.left = tower.x + "px";
      el.style.top = tower.y + "px";
      gameArea.appendChild(el);
    }
    towers.forEach(spawnTower);

    // Lista de inimigos vivos
    const enemies = [];

    // Função para mover inimigos entre waypoints do seu caminho
    function moveAlongPath(enemy) {
      const path = paths[enemy.path];
      if (enemy.currentTargetIndex === undefined) enemy.currentTargetIndex = 1;
      const target = path[enemy.currentTargetIndex];
      const dx = target.x - enemy.x;
      const dy = target.y - enemy.y;
      const dist = Math.sqrt(dx * dx + dy * dy);

      if (dist < enemy.speed) {
        // Chegou no ponto, avança
        enemy.x = target.x;
        enemy.y = target.y;
        enemy.currentTargetIndex++;
        if (enemy.currentTargetIndex >= path.length) {
          // Chegou no castelo!
          enemyReachedCastle(enemy);
          return;
        }
      } else {
        enemy.x += (dx / dist) * enemy.speed;
        enemy.y += (dy / dist) * enemy.speed;
      }
      enemy.element.style.left = enemy.x + "px";
      enemy.element.style.top = enemy.y + "px";

      // Atualiza barra de vida
      enemy.hpBar.style.width = (enemy.hp / enemy.maxHp) * 20 + "px";
      enemy.hpBar.style.background = enemy.hp / enemy.maxHp < 0.5 ? "yellow" : "green";
    }

    // Quando inimigo chega no castelo, tira vida do castelo e remove inimigo
    function enemyReachedCastle(enemy) {
      castleHp -= 10;
      if (castleHp < 0) castleHp = 0;
      updateCastleHp();
      clearInterval(enemy.moveInterval);
      enemy.element.remove();
      const index = enemies.indexOf(enemy);
      if(index > -1) enemies.splice(index,1);
    }

    // Função para spawnar inimigos
    function spawnEnemy(type = "normal") {
      // Escolhe aleatoriamente o caminho
      const pathsKeys = Object.keys(paths);
      const chosenPath = pathsKeys[Math.floor(Math.random() * pathsKeys.length)];

      const enemyEl = document.createElement("div");
      enemyEl.className = "enemy";

      const hpBar = document.createElement("div");
      hpBar.className = "hpbar";
      enemyEl.appendChild(hpBar);

      let speed, maxHp;
      switch(type) {
        case "fast":
          speed = 4;
          maxHp = 100;
          enemyEl.style.background = "orange";
          break;
        case "tank":
          speed = 1;
          maxHp = 500;
          enemyEl.style.background = "blue";
          break;
        default:
          speed = 2;
          maxHp = 150;
      }

      const enemy = {
        element: enemyEl,
        path: chosenPath,
        x: paths[chosenPath][0].x,
        y: paths[chosenPath][0].y,
        speed,
        hp: maxHp,
        maxHp,
        currentTargetIndex: 1,
        hpBar: hpBar,
        hitCooldown: false
      };

      enemyEl.style.left = enemy.x + "px";
      enemyEl.style.top = enemy.y + "px";

      gameArea.appendChild(enemyEl);

      enemy.moveInterval = setInterval(() => {
        moveAlongPath(enemy);
        towerAttack(enemy);
        if(enemy.hp <= 0) {
          clearInterval(enemy.moveInterval);
          enemy.element.remove();
          gold += 10;
          goldDisplay.textContent = gold;
          localStorage.setItem("gold", gold);

          // Remove da lista enemies
          const index = enemies.indexOf(enemy);
          if(index > -1) enemies.splice(index,1);
        }
      }, 30);

      enemies.push(enemy);
    }

    // Função para disparar projéteis
    function shootProjectile(x, y, target, damage) {
      const proj = document.createElement("div");
      proj.className = "projectile";
      proj.style.left = x + "px";
      proj.style.top = y + "px";
      gameArea.appendChild(proj);

      let px = x;
      let py = y;

      const projInterval = setInterval(() => {
        const dx = target.x - px;
        const dy = target.y - py;
        const dist = Math.sqrt(dx*dx + dy*dy);
    if(dist < 4) {
      target.hp -= damage;
      clearInterval(projInterval);
      proj.remove();
      return;
    }
    px += (dx / dist) * 6;
    py += (dy / dist) * 6;
    proj.style.left = px + "px";
    proj.style.top = py + "px";
  }, 20);
}

// As torres atacam os inimigos dentro do alcance
function towerAttack(enemy) {
  towers.forEach(tower => {
    const dx = tower.x - enemy.x;
    const dy = tower.y - enemy.y;
    const dist = Math.sqrt(dx*dx + dy*dy);
    if (dist < tower.range && !enemy.hitCooldown) {
      enemy.hitCooldown = true;
      shootProjectile(tower.x, tower.y, enemy, towerDamage);
      setTimeout(() => enemy.hitCooldown = false, 1000);
    }
  });
}

function upgradeTower() {
  if (gold >= 50) {
    gold -= 50;
    towerDamage += 5;
    goldDisplay.textContent = gold;
    damageDisplay.textContent = towerDamage;
    localStorage.setItem("gold", gold);
    localStorage.setItem("towerDamage", towerDamage);
  }
}

// Início das ondas
function startWave() {
  wave++;
  waveDisplay.textContent = wave;
  localStorage.setItem("wave", wave);

  if (wave % 10 === 0) {
    castleMaxHp += 20;
    castleHp += 20;
    updateCastleHp();
  }

  let spawnCount = wave * 4;
  let spawnInterval = setInterval(() => {
    if(spawnCount <= 0) {
      clearInterval(spawnInterval);
      setTimeout(startWave, 5000);
      return;
    }

    let r = Math.random();
    if(r < 0.15) spawnEnemy("tank");
    else if(r < 0.5) spawnEnemy("fast");
    else spawnEnemy("normal");

    spawnCount--;
  }, 1000);
}

startWave();
</script>
</body>
</html>